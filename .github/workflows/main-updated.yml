name: main-updated

on:
  workflow_dispatch:
  push:
    branches: [ main ]

env:
  # '-XX:MaxMetaspaceSize=1g' must be set because Gradle sets it to 256m,
  # but that setting is removed when setting custom jvmArgs and the default from the JVM is unbound
  # see https://github.com/gradle/gradle/issues/19750
  GRADLE_OPTS_WINDOWS: -Xmx4g -XX:MaxMetaspaceSize=1g -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8 -Dorg.gradle.configureondemand=false -Dorg.gradle.daemon=false -Dkotlin.compiler.execution.strategy=in-process -Dkotlin.incremental=false
  GRADLE_OPTS_MACOS: -Xmx10g -XX:MaxMetaspaceSize=1g -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8 -Dorg.gradle.configureondemand=false -Dorg.gradle.daemon=false -Dkotlin.compiler.execution.strategy=in-process -Dkotlin.incremental=false
  GRADLE_OPTS_UBUNTU: -Xmx5g -XX:MaxMetaspaceSize=1g -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8 -Dorg.gradle.configureondemand=false -Dorg.gradle.daemon=false -Dkotlin.compiler.execution.strategy=in-process -Dkotlin.incremental=false

jobs:

  build-logic:
    runs-on: macos-latest
    steps:
      - name: check out
        uses: actions/checkout@v3

      - name: build build-logic
        uses: ./.github/actions/gradle-task
        with:
          task: :build-logic:compileKotlin :build-logic:jar
          write-cache-key: build-logic-jar

  build-all:
    runs-on: macos-latest
    steps:
      - name: check out
        uses: actions/checkout@v3

      - name: main build
        uses: ./.github/actions/gradle-task
        with:
          task: jar compileKotlin
          restore-cache-key: build-logic-jar
          write-cache-key: main-build-artifacts

  publish-snapshot:
    needs:
      - build-all
    if: github.repository == 'RBusarow/ModuleCheck'
    runs-on: macos-latest

    steps:
      - name: check out
        uses: actions/checkout@v3

      - name: Dokka & JavadocJar
        uses: ./.github/actions/gradle-task
        with:
          task: dokkaJavadocJar
          restore-cache-key: main-build-artifacts

      - name: Publish Snapshots
        uses: ./.github/actions/gradle-task
        with:
          task: publish
          write-cache-key: local-m2
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.SONATYPE_NEXUS_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.SONATYPE_NEXUS_PASSWORD }}

  publish-website:
    needs:
      - build-all
    runs-on: macos-latest
    steps:
      - name: check out
        uses: actions/checkout@v3

      - name: dokkaHtmlMultiModule
        uses: ./.github/actions/gradle-task
        with:
          task: dokkaHtmlMultiModule
          restore-cache-key: main-build-artifacts
          write-cache-key: dokka-build-artifacts

      - name: website build cache
        uses: actions/cache@v3
        with:
          path: |
            website/.docusaurus
            website/build
            website/node_modules
          key: website-build
          enableCrossOsArchive: true

      # Node is required for npm
      - name: Set up Node
        uses: actions/setup-node@v3
        with:
          node-version: 18.x
          cache: yarn
          cache-dependency-path: website/yarn.lock

      - name: Install Yarn
        working-directory: website
        run: yarn install --frozen-lockfile

      - name: build website
        uses: ./.github/actions/gradle-task
        with:
          task: buildSite
          write-cache-key: website-build

      - name: Deploy to GitHub Pages
        if: success()
        uses: crazy-max/ghaction-github-pages@v3
        with:
          target_branch: gh-pages
          build_dir: website/build
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
